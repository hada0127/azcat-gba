# GBA 컨버팅 계획: 아! 고양이를 피해라 대왕

## Context

2003년 Cherry Project에서 GP32/Flash용으로 제작된 "아! 고양이를 피해라 대왕" (azcat.swf)을
GBA(Game Boy Advance, 240x160) ROM으로 새로 제작한다.
원본 Flash 에셋(export/)과 분석 리포트(report.md)를 참고하여 최대한 원본 느낌을 재현한다.

## 핵심 변경사항

- **화면**: 타이틀 + 게임플레이 + 게임오버만 유지 (매뉴얼, Cherry Project 소개 제거)
- **레이아웃**: 우측 UI 패널 제거 → 점수는 중앙 상단, 캐릭터 박스+폭탄 표시는 우측 상단
- **개발환경**: devkitARM + libtonc (C언어)
- **그래픽**: Mode 4 비트맵 배경 + OAM 하드웨어 스프라이트

---

## 원본 vs GBA 레이아웃 비교

### 원본 (320x240, 게임 영역 ~210x240 + 우측 패널 ~110px)

```
┌──────────────────┬────────┐
│                  │ 캐릭터 │ 240
│   게임 영역      │ 대사   │
│   (210x240)      │ 점수   │
│                  │ 로고   │
│   플레이어/고양이 │ 폭탄   │
└──────────────────┴────────┘
         320px
```

### GBA (240x160, 전체 영역 사용)

```
┌──────────────────────────────┐
│  SCORE:0000   [캐릭터][폭탄] │ ← HUD (16px)
├──────────────────────────────┤
│                              │
│      게임 영역 (240x144)     │
│   고양이 낙하 / 아이템       │
│                              │
│      ─── 플레이어 ───        │
│══════════════ 바닥 ══════════│
└──────────────────────────────┘
            240px
```

---

## 좌표 스케일링

| 항목 | 원본 | GBA | 비고 |
|------|------|-----|------|
| 해상도 | 320x240 | 240x160 | |
| 게임 영역 폭 | 210px | 240px | 풀스크린 |
| 게임 영역 높이 | ~240px | 144px (HUD 16px 제외) | |
| 플레이어 X 범위 | 0~189 | 0~216 | 스프라이트 24px 감안 |
| 플레이어 초기 X | 93 | 108 | 화면 중앙 |
| 고양이 스폰 X | 1~205 | 1~224 | |
| 고양이 스폰 Y | -32~-192 | -20~-120 | |
| 고양이 착지 Y | 200 | 136 | HUD 16 + 게임영역 120 |
| 충돌 판정 Y | 170~190 | 116~136 | |
| 아이템 착지 Y | 207 | 140 | |
| 바닥 Y | ~210 | 144 | |

---

## 체크리스트

### Phase 1: 프로젝트 셋업

- [ ] devkitARM / devkitPro 설치 확인
- [ ] 프로젝트 디렉토리 구조 생성

```
azcat-gba/
├── source/           # C 소스코드
│   ├── main.c        # 메인 엔트리, 게임 상태 머신
│   ├── title.c/h     # 타이틀 화면
│   ├── game.c/h      # 게임플레이 로직
│   ├── gameover.c/h  # 게임오버 화면
│   ├── player.c/h    # 플레이어 시스템
│   ├── cat.c/h       # 고양이 시스템
│   ├── item.c/h      # 아이템 시스템
│   ├── bomb.c/h      # 폭탄 시스템
│   ├── hud.c/h       # HUD (점수, 캐릭터, 폭탄표시)
│   ├── bg.c/h        # 배경 관리
│   └── save.c/h      # SRAM 하이스코어 저장
├── graphics/         # 변환 전 원본 이미지
├── data/             # 변환된 GBA 에셋 (.h/.c)
├── include/          # 공통 헤더
├── Makefile
└── azcat.gba         # 최종 ROM 출력
```

- [ ] Makefile 작성 (libtonc 링크, grit 에셋 파이프라인)

### Phase 2: 에셋 변환

#### 배경 이미지 변환 (240x160, 8bpp 팔레트)

- [ ] 타이틀 배경: `export/images/8.jpg` 기반 → 240x160으로 리사이즈/크롭
- [ ] 게임 낮 배경: `export/images/69.jpg` 기반 → 240x160
- [ ] 게임 밤 배경: 낮 배경 색조 변환으로 생성
- [ ] 게임 매트릭스 배경: `export/images/71.jpg` 기반 → 240x160
- [ ] 게임오버 배경: 게임 배경 재활용 (어둡게)
- [ ] 각 배경을 grit으로 `.c/.h` 변환 (8bpp, 256색 팔레트)

#### 스프라이트 변환 (4bpp OAM, 16색 팔레트)

- [ ] 플레이어 캐릭터: `export/images/56.png` → 32x32 OAM (좌/우/정지/사망 4프레임)
- [ ] 고양이: `export/images/37.png`(흰), `39.png`(갈) → 16x16 OAM (낙하/착지 2프레임)
- [ ] 아이템 4종: 체력(37계열), 폭탄, 독, 속도 → 16x16 OAM
- [ ] 폭발 이펙트: `export/images/52.png` 기반 → 32x32 OAM (3~4프레임 축약)
- [ ] 캐릭터 얼굴 4종: `export/images/28.png`(헤헤), `30.png`(흠), `32.png`(아파), `34.png`(깨당) → 32x32 OAM
- [ ] 폭탄 보유 아이콘: 16x16 OAM

#### 폰트/텍스트

- [ ] 숫자 0~9 타일 폰트 (점수 표시용, 8x8 또는 8x16)
- [ ] "SCORE", "HISCORE" 등 고정 텍스트 → 미리 렌더링된 타일
- [ ] 한글 텍스트 → 비트맵으로 미리 렌더링 (등급명, 메뉴 텍스트 등)
- [ ] 게임오버 등급 텍스트: `export/images/81~123.png` 참고하여 재제작

### Phase 3: 핵심 시스템 구현

#### 게임 상태 머신 (main.c)

- [ ] 상태: `STATE_TITLE` → `STATE_PLAY` → `STATE_GAMEOVER` → (반복)
- [ ] VBlank 인터럽트 기반 프레임 루프 (60fps 또는 30fps)
- [ ] 더블 버퍼링 (Mode 4 page flip)

#### 타이틀 화면 (title.c)

- [ ] 타이틀 배경 표시 (Mode 4 비트맵)
- [ ] HISCORE 표시 (SRAM에서 로드)
- [ ] 키 입력: →(Start) 게임 시작 / 다른 키 무시 (매뉴얼/Cherry 제거됨)
- [ ] 원본 로고/고양이 얼굴 배치 재현

#### 플레이어 시스템 (player.c)

- [ ] OAM 스프라이트로 표시 (32x32)
- [ ] 상태: `idle_left`, `idle_right`, `left`, `right`, `dead`
- [ ] 조작 방식 변경 (원본과 다름): **키를 누르고 있는 동안만 이동, 떼면 즉시 정지**
  - 원본: 한번 누르면 계속 이동 + ↓키로 정지
  - GBA: 매 프레임 키 홀드 체크 (`key_is_down()`) → 홀드 중이면 이동, 아니면 idle
  - ↓키 정지 기능 삭제
- [ ] 이동: `X += 5 + v_accel + player_accel` (`v_accel += 0.2/프레임`, 키 떼면 v_accel 리셋)
- [ ] 고정소수점 연산 사용 (.8 fixed point)
- [ ] X 범위 제한: 0 ~ 216
- [ ] 폭탄 사용 중 이동 불가
- [ ] 좌/우 스프라이트 플립 (OAM hflip)

#### 고양이 시스템 (cat.c)

- [ ] 고양이 배열 33개 (구조체: x, y, v_accel, active, state)
- [ ] 스폰: 랜덤 X(1~224), Y(-20~-120)
- [ ] 낙하: `Y += 1 + v_accel + v_cat_accel` (`v_accel += 0.5`)
- [ ] 고정소수점 연산 (.8 fixed point)
- [ ] 착지: Y > 136 → score += 1, "sit" 상태
- [ ] 충돌 판정: Y 116~136 구간에서 플레이어 히트박스와 X축 겹침
- [ ] 피격 시: `player_life -= 1`, 고양이 제거
- [ ] 폭탄 반응: `bomb_use == 1`이면 모든 고양이 즉시 제거
- [ ] 활성화: `v_cat_qty`로 제어
- [ ] OAM 스프라이트 33개 사용 (16x16)

#### 아이템 시스템 (item.c)

- [ ] 출현 조건: `item_cnt > 149` (약 150프레임마다)
- [ ] 스폰: 랜덤 X(1~224), Y = -24
- [ ] 낙하: `Y += 1 + v_accel` (`v_accel += 0.5`)
- [ ] 바닥 체류: Y=140에서 정지, 45프레임 후 소멸
- [ ] 획득 판정: 플레이어 히트박스와 겹침 검사
- [ ] 아이템 효과 적용:
  - **i1(체력회복)**: HP+1 (최대3), 초과시 score+5
  - **i2(폭탄)**: bomb_have=1, 초과시 score+5
  - **i3(HP감소)**: HP-1 (최소1), 초과시 score-5
  - **i4(속도업)**: player_accel+1 (최대4), 초과시 score+5
- [ ] OAM 스프라이트 1개 사용 (16x16)

#### 폭탄 시스템 (bomb.c)

- [ ] PageUp(L버튼) 입력 시 `bomb_have==1`이면 발동
- [ ] 폭발 이펙트 표시 (OAM 32x32, 간략화된 애니메이션)
- [ ] 모든 고양이 즉시 제거
- [ ] 사용 중 플레이어 이동/고양이 낙하 정지
- [ ] 약 20프레임 후 복구 (원본 41프레임에서 단축)

#### 난이도 시스템 (game.c 내 구현)

- [ ] 점수 기반 `v_cat_qty` 테이블 (report.md 난이도 곡선 그대로 이식)
- [ ] 점수 기반 `v_cat_accel` 테이블 (report.md 그대로 이식)
- [ ] 배경 전환: 0~500(낮), 500~900(밤), 900+(매트릭스)

### Phase 4: HUD 구현

#### HUD 레이아웃 (hud.c) - 상단 16px 영역

```
┌──────────────────────────────┐
│ SCORE:00000  [얼굴32x][폭탄]│
└──────────────────────────────┘
```

- [ ] 점수: 화면 중앙 상단 (숫자 폰트로 렌더링)
- [ ] 캐릭터 얼굴: 우측 상단 (32x32 또는 축소, HP에 따라 4종 변경)
  - life3: 헤헤 (여유) → `images/28.png`
  - life2: 흠 (보통) → `images/30.png`
  - life1: 아파 (위험) → `images/32.png`
  - dead: 깨당 → `images/34.png`
- [ ] 폭탄 보유 아이콘: 캐릭터 얼굴 옆 (원본과 동일하게 폭탄 이미지 표기)
- [ ] Mode 4 비트맵 위에 직접 그리거나 OAM 스프라이트로 오버레이

### Phase 5: 게임오버 화면

- [ ] 배경 어둡게 처리 (현재 게임 배경 유지 + 반투명 오버레이)
- [ ] 등급 표시 (점수 기반, report.md 등급 테이블 이식)
- [ ] 등급명 + 점수 중앙 표시
- [ ] 선택지: ← 타이틀 / → 재도전
- [ ] 하이스코어 갱신 시 SRAM 저장

### Phase 6: 사운드

- [ ] 사운드 시스템 (선택적, 후순위)
  - MaxMod 또는 직접 DMA 사운드
  - `export/sounds/79.mp3` → GBA용 변환 (MOD/S3M 또는 raw PCM 8bit)
  - 효과음 변환: `12.mp3`, `46.mp3`, `54.mp3`, `126.mp3`
  - 사운드 없이도 플레이 가능하게 설계

### Phase 7: 세이브 시스템

#### SRAM 하이스코어 (save.c)

- [ ] SRAM 32KB 영역에 하이스코어 저장
- [ ] 매직넘버 체크로 유효성 검증
- [ ] 게임오버 시 갱신, 타이틀에서 로드

### Phase 8: 통합 및 테스트

- [ ] 전체 게임 흐름 연결 (타이틀→게임→게임오버 순환)
- [ ] mGBA 또는 VisualBoyAdvance로 테스트
- [ ] 30fps 안정 동작 확인 (33 고양이 + 아이템 동시 처리)
- [ ] OAM 스프라이트 사용량 확인 (최대 128개 중 ~40개 사용 예상)
- [ ] 입력 반응성 테스트 (D-pad 좌/우, 아래, L버튼)
- [ ] 난이도 곡선 밸런스 확인
- [ ] SRAM 세이브/로드 확인
- [ ] ROM 크기 확인 (목표: 256KB 이내)

---

## GBA 조작 매핑

| 원본 키 | GBA 버튼 | 동작 |
|---------|----------|------|
| ← 방향키 | D-Pad Left | 좌 이동 (홀드) / 타이틀로 |
| → 방향키 | D-Pad Right | 우 이동 (홀드) / 게임시작, 재도전 |
| ~~↓ 방향키~~ | ~~삭제~~ | ~~정지~~ → 키를 떼면 자동 정지 |
| PageUp | L 버튼 | 전멸 폭탄 사용 |
| - | START | 게임 시작 (타이틀에서) |

---

## 참조 파일 (export/ 에셋)

| 용도 | 원본 파일 | 변환 대상 |
|------|----------|----------|
| 타이틀 배경 | `export/images/8.jpg` | 240x160 8bpp |
| 낮 배경 | `export/images/69.jpg` | 240x160 8bpp |
| 매트릭스 배경 | `export/images/71.jpg` | 240x160 8bpp |
| 플레이어 | `export/images/56.png` | 32x32 4bpp OAM |
| 흰 고양이 | `export/images/37.png` | 16x16 4bpp OAM |
| 갈색 고양이 | `export/images/39.png` | 16x16 4bpp OAM |
| 캐릭터 얼굴(헤헤) | `export/images/28.png` | 32x32 4bpp OAM |
| 캐릭터 얼굴(흠) | `export/images/30.png` | 32x32 4bpp OAM |
| 캐릭터 얼굴(아파) | `export/images/32.png` | 32x32 4bpp OAM |
| 캐릭터 얼굴(깨당) | `export/images/34.png` | 32x32 4bpp OAM |
| 폭발 이펙트 | `export/images/52.png` | 32x32 4bpp OAM |
| 아이템(건물) | `export/images/41.png` | 16x16 4bpp OAM |
| 아이템(불꽃) | `export/images/43.png` | 16x16 4bpp OAM |
| 등급 텍스트 | `export/images/81~123.png` | 비트맵 텍스트 |
| 게임 로직 참고 | `export/scripts/DefineSprite_*` | C 코드로 재작성 |

---

## 검증 방법

1. **빌드 테스트**: `make` 명령으로 `.gba` ROM 정상 생성 확인
2. **에뮬레이터 테스트**: mGBA에서 실행하여 각 화면 전환 확인
3. **게임플레이 테스트**: 고양이 낙하, 충돌 판정, 점수 증가, 아이템 효과 확인
4. **성능 테스트**: 고양이 43개 활성 시 프레임 드롭 없는지 확인
5. **세이브 테스트**: 하이스코어 저장/로드 확인
